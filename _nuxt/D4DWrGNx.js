import{_ as ge}from"./BOkNnYrX.js";import{e as be,g as xe,E as ye,o as d,c as g,a as l,i as a,m as E,p as S,n as G,b as _,l as he,t as $,F as we,r as _e,w as J,j as ke,q as K,v as se,G as Q,H as Te,d as ae,I as Se,y as c,A as Re}from"./BXS-ooRf.js";import{_ as De}from"./DeYFpVP_.js";import{u as Ce,f as ne}from"./D0zQGYhG.js";const Ue=globalThis.setInterval,Me={class:"space-y-5"},Ie={class:"flex flex-col items-center gap-3 py-8"},$e=["aria-label"],Ne={key:0,class:"text-red-400 text-sm font-mono tabular-nums animate-pulse"},je={key:1,class:"text-xs text-primary-400 animate-pulse"},Pe={key:2,class:"text-xs text-slate-500"},Ae={key:3,class:"w-full max-w-sm bg-slate-800/60 rounded-2xl px-4 py-3 text-sm text-slate-300 min-h-[3rem]"},Be={class:"text-slate-500 italic"},Ve={key:1,class:"flex flex-col items-center gap-2 py-6 text-center"},ze={key:2,class:"space-y-2"},Ee={class:"flex items-center gap-3"},Le={class:"flex-1 min-w-0"},Oe={class:"text-sm text-slate-300 truncate"},Fe={key:0,class:"fixed inset-0 z-50 flex items-end sm:items-center justify-center"},qe={class:"relative w-full sm:max-w-md bg-slate-900 border border-slate-800 rounded-t-3xl sm:rounded-2xl p-5 space-y-4"},He={class:"flex items-center justify-between"},Ye={class:"space-y-1"},Ge={class:"space-y-1"},Je={key:0,class:"flex items-center gap-2 cursor-pointer"},Ke={class:"flex gap-2"},Qe="habitat",k="voice_notes",st=be({__name:"voice",setup(We){let L=null;function O(){return L?Promise.resolve(L):new Promise((t,e)=>{const s=indexedDB.open(Qe,1);s.onupgradeneeded=()=>{s.result.createObjectStore(k,{keyPath:"id"})},s.onsuccess=()=>{L=s.result,t(s.result)},s.onerror=()=>e(s.error)})}async function oe(){const t=await O();return new Promise((e,s)=>{const i=t.transaction(k,"readonly").objectStore(k).getAll();i.onsuccess=()=>e(i.result),i.onerror=()=>s(i.error)})}async function le(t){const e=await O();return new Promise((s,i)=>{const o=e.transaction(k,"readwrite");o.objectStore(k).put(t),o.oncomplete=()=>s(),o.onerror=()=>i(o.error)})}async function ie(t){const e=await O();return new Promise((s,i)=>{const o=e.transaction(k,"readwrite");o.objectStore(k).delete(t),o.oncomplete=()=>s(),o.onerror=()=>i(o.error)})}const N=window.SpeechRecognition?()=>new window.SpeechRecognition:window.webkitSpeechRecognition?()=>new window.webkitSpeechRecognition:null,R=N!==null;let f=null;const h=c(""),u=c("");function re(t){if(!N)throw new Error("SpeechRecognition not supported");const e=N();return e.continuous=!0,e.interimResults=!0,e.lang=navigator.language||"en-US",e.onresult=s=>{let i="";for(let o=s.resultIndex;o<s.results.length;o++){const m=s.results[o];m&&(m.isFinal?u.value+=m[0].transcript:i+=m[0].transcript)}h.value=i},e.onend=()=>{if(h.value="",f===e)if(v.value)try{e.start()}catch{}else f=null,t?.()},e.onerror=s=>{s.error!=="no-speech"&&s.error!=="aborted"&&(x.value=`Speech recognition error: ${s.error}`)},e}function W(t){if(N){u.value="",h.value="",f=re(t);try{f.start()}catch{f=null}}}function F(){if(!f)return;const t=f;f=null,B.value=!1;try{t.stop()}catch{}}const X=Re(),{settings:D}=Ce(),q=c(!1),C=c(""),U=c(""),H=c(!1),M=c(null),I=c(!1);function j(t=null){const e=new Date,s=e.toISOString().slice(0,10),i=ne(e,D.value.use24HourTime);C.value=`Voice note — ${s}, ${i}`,U.value=u.value,M.value=t,I.value=!1,q.value=!0}function P(){q.value=!1,u.value="",h.value="",M.value=null}async function ce(){if(X.isAvailable){H.value=!0;try{if(await X.createScribble({title:C.value.trim()||"Voice note",content:U.value,tags:["habitat-transcribed"],annotations:{}}),M.value&&I.value){const t=b.value.find(e=>e.id===M.value);t&&await te(t)}P()}finally{H.value=!1}}}const b=c([]),v=c(!1),A=c(0),x=c(null),r=c(null),B=c(!1);let w=null,Y=[],V=null,z=null;const y=new Map;xe(async()=>{const t=await oe();t.sort((e,s)=>s.created_at.localeCompare(e.created_at)),b.value=t.map(e=>({...e,url:URL.createObjectURL(e.blob)}))}),ye(()=>{ee(),F(),b.value.forEach(t=>{t.url&&URL.revokeObjectURL(t.url)}),y.forEach(t=>t.pause())});function ue(){const t=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4"];for(const e of t)if(MediaRecorder.isTypeSupported(e))return e;return""}function Z(t){const e=Math.floor(t/60),s=t%60;return`${e}:${String(s).padStart(2,"0")}`}function de(t){const e=new Date(t),s=new Date,i=new Date(s);i.setDate(s.getDate()-1);const o=(n,T)=>n.getFullYear()===T.getFullYear()&&n.getMonth()===T.getMonth()&&n.getDate()===T.getDate(),m=ne(e,D.value.use24HourTime);return o(e,s)?`Today, ${m}`:o(e,i)?`Yesterday, ${m}`:new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"}).format(e)+`, ${m}`}async function pe(){x.value=null;let t;try{t=await navigator.mediaDevices.getUserMedia({audio:!0})}catch{x.value="Microphone access denied. Please allow access in your browser settings.";return}Y=[];const e=ue();w=new MediaRecorder(t,e?{mimeType:e}:void 0),w.ondataavailable=s=>{s.data.size>0&&Y.push(s.data)},w.onstop=async()=>{t.getTracks().forEach(o=>o.stop());const s=new Blob(Y,{type:e||"audio/webm"}),i={id:crypto.randomUUID(),blob:s,mimeType:e||"audio/webm",duration:A.value,created_at:new Date().toISOString()};await le(i),b.value.unshift({...i,url:URL.createObjectURL(s)}),A.value=0,z=i.id,R&&f?B.value=!0:(D.value.saveTranscribedNotes&&u.value.trim()?j(i.id):u.value="",z=null)},w.start(100),v.value=!0,V=Ue(()=>{A.value++},1e3),R&&W(()=>{B.value=!1,D.value.saveTranscribedNotes&&u.value.trim()?j(z):u.value="",z=null})}function ee(){if(f)try{f.stop()}catch{}w&&w.state!=="inactive"&&w.stop(),v.value=!1,V&&(clearInterval(V),V=null)}function fe(){v.value?ee():pe()}function ve(t){if(!t.url)return;r.value&&r.value!==t.id&&(y.get(r.value)?.pause(),r.value=null);let e=y.get(t.id);e||(e=new Audio(t.url),e.onended=()=>{r.value=null},y.set(t.id,e)),r.value===t.id?(e.pause(),r.value=null):(e.play(),r.value=t.id)}const p=c(null);async function me(t){if(!R||!t.url||p.value)return;r.value&&(y.get(r.value)?.pause(),r.value=null),p.value=t.id,x.value=null,u.value="",h.value="";const e=new Audio(t.url);y.set(t.id,e),e.onended=()=>{F(),r.value=null,p.value=null,D.value.saveTranscribedNotes&&u.value.trim()||u.value.trim()?j(t.id):(x.value="No speech detected in this recording.",u.value="")},W(),e.play(),r.value=t.id}async function te(t){const e=y.get(t.id);e&&(e.pause(),y.delete(t.id)),r.value===t.id&&(r.value=null),p.value===t.id&&(F(),p.value=null),t.url&&URL.revokeObjectURL(t.url),await ie(t.id),b.value=b.value.filter(s=>s.id!==t.id)}return(t,e)=>{const s=ge,i=he,o=ke,m=De;return d(),g("div",Me,[e[11]||(e[11]=l("header",null,[l("p",{class:"text-sm text-slate-500"},"Voice Notes"),l("h2",{class:"text-2xl font-bold"},"Record")],-1)),a(x)?(d(),E(s,{key:0,title:a(x),color:"error",variant:"soft",icon:"i-heroicons-exclamation-circle","close-button":{icon:"i-heroicons-x-mark",color:"error",variant:"ghost",size:"sm"},onClose:e[0]||(e[0]=n=>x.value=null)},null,8,["title"])):S("",!0),l("div",Ie,[l("button",{class:G(["w-24 h-24 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500",a(v)?"bg-red-500 shadow-xl shadow-red-500/30 scale-105":"bg-slate-800 hover:bg-slate-700"]),"aria-label":a(v)?"Stop recording":"Start recording",onClick:fe},[_(i,{name:a(v)?"i-heroicons-stop":"i-heroicons-microphone",class:G(["w-10 h-10",a(v)?"text-white":"text-slate-300"])},null,8,["name","class"])],10,$e),a(v)?(d(),g("p",Ne," ● "+$(Z(a(A))),1)):a(B)?(d(),g("p",je," Finishing transcription… ")):(d(),g("p",Pe,"Tap to record")),a(v)&&R&&(a(u)||a(h))?(d(),g("div",Ae,[l("span",null,$(a(u)),1),l("span",Be,$(a(h)),1)])):S("",!0)]),a(b).length===0&&!a(v)?(d(),g("section",Ve,[_(i,{name:"i-heroicons-microphone",class:"w-8 h-8 text-slate-700"}),e[4]||(e[4]=l("p",{class:"text-sm text-slate-500"},"No recordings yet. Tap the button above to start.",-1))])):a(b).length>0?(d(),g("div",ze,[(d(!0),g(we,null,_e(a(b),n=>(d(),E(m,{key:n.id,ui:{root:"rounded-2xl",body:"px-4 py-3 sm:px-4 sm:py-3"}},{default:J(()=>[l("div",Ee,[_(o,{icon:a(r)===n.id?"i-heroicons-pause":"i-heroicons-play",color:a(r)===n.id?"primary":"neutral",variant:a(r)===n.id?"soft":"outline",size:"sm",ui:{base:"rounded-full"},disabled:a(p)===n.id,onClick:T=>a(p)===n.id?void 0:ve(n)},null,8,["icon","color","variant","disabled","onClick"]),l("div",Le,[l("p",Oe,$(de(n.created_at)),1),l("p",{class:G(["text-xs tabular-nums",a(p)===n.id?"text-primary-400 animate-pulse":"text-slate-500"])},$(a(p)===n.id?"Transcribing…":Z(n.duration)),3)]),R?(d(),E(o,{key:0,icon:"i-heroicons-language",color:"neutral",variant:"ghost",size:"sm",class:"text-slate-600 hover:text-primary-400",loading:a(p)===n.id,disabled:!!a(p)&&a(p)!==n.id,onClick:T=>me(n)},null,8,["loading","disabled","onClick"])):S("",!0),_(o,{icon:"i-heroicons-trash",color:"neutral",variant:"ghost",size:"sm",class:"text-slate-600 hover:text-red-400",disabled:a(p)===n.id,onClick:T=>te(n)},null,8,["disabled","onClick"])])]),_:2},1024))),128))])):S("",!0),(d(),E(Se,{to:"body"},[a(q)?(d(),g("div",Fe,[l("div",{class:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:P}),l("div",qe,[l("div",He,[e[5]||(e[5]=l("h3",{class:"text-base font-semibold"},"Save transcription",-1)),_(o,{icon:"i-heroicons-x-mark",variant:"ghost",color:"neutral",size:"sm",onClick:P})]),l("div",Ye,[e[6]||(e[6]=l("label",{class:"text-xs text-slate-500 font-medium"},"Title",-1)),K(l("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>Q(C)?C.value=n:null),type:"text",class:"w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-primary-500"},null,512),[[se,a(C)]])]),l("div",Ge,[e[7]||(e[7]=l("label",{class:"text-xs text-slate-500 font-medium"},"Transcript",-1)),K(l("textarea",{"onUpdate:modelValue":e[2]||(e[2]=n=>Q(U)?U.value=n:null),rows:"5",class:"w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-primary-500 resize-none"},null,512),[[se,a(U)]])]),a(M)?(d(),g("label",Je,[K(l("input",{"onUpdate:modelValue":e[3]||(e[3]=n=>Q(I)?I.value=n:null),type:"checkbox",class:"rounded border-slate-600 bg-slate-800 text-primary-500 focus:ring-primary-500"},null,512),[[Te,a(I)]]),e[8]||(e[8]=l("span",{class:"text-sm text-slate-400"},"Delete voice recording after saving",-1))])):S("",!0),l("div",Ke,[_(o,{class:"flex-1",color:"primary",loading:a(H),onClick:ce},{default:J(()=>[...e[9]||(e[9]=[ae(" Save to Scribbles ",-1)])]),_:1},8,["loading"]),_(o,{variant:"outline",color:"neutral",onClick:P},{default:J(()=>[...e[10]||(e[10]=[ae(" Discard ",-1)])]),_:1})])])])):S("",!0)]))])}}});export{st as default};
